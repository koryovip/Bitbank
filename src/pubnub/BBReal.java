package pubnub;

import java.util.List;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.pubnub.api.PNConfiguration;
import com.pubnub.api.PubNub;
import com.pubnub.api.callbacks.SubscribeCallback;
import com.pubnub.api.models.consumer.PNStatus;
import com.pubnub.api.models.consumer.pubsub.PNMessageResult;
import com.pubnub.api.models.consumer.pubsub.PNPresenceEventResult;

public abstract class BBReal {

    protected void onMessage(PubNub pubnub, PNMessageResult message, pubnub.json.candlestick.Message hoge) {
    };

    protected void onMessage(PubNub pubnub, PNMessageResult message, pubnub.json.ticker.Message hoge) {
    };

    protected void onMessage(PubNub pubnub, PNMessageResult message, pubnub.json.depth.Message hoge) {
    };

    protected void onMessage(PubNub pubnub, PNMessageResult message, pubnub.json.transactions.Message hoge) {
    };

    protected abstract void onError(PubNub pubnub, PNMessageResult message, Throwable t);

    protected abstract List<String> channels();

    private final ObjectMapper mapper = new ObjectMapper();

    final public void monitor() {
        PNConfiguration pnConfiguration = new PNConfiguration();
        pnConfiguration.setSubscribeKey("sub-c-e12e9174-dd60-11e6-806b-02ee2ddab7fe");
        // pnConfiguration.setPublishKey("candlestick_btc_jpy");
        pnConfiguration.setSecure(false);

        PubNub pubnub = new PubNub(pnConfiguration);

        pubnub.addListener(new SubscribeCallback() {
            @Override
            public void status(PubNub pubnub, PNStatus status) {
                if (status.getOperation() != null) {
                    switch (status.getOperation()) {
                    // let's combine unsubscribe and subscribe handling for ease of use
                    case PNSubscribeOperation:
                    case PNUnsubscribeOperation:
                        // note: subscribe statuses never have traditional
                        // errors, they just have categories to represent the
                        // different issues or successes that occur as part of subscribe
                        switch (status.getCategory()) {
                        case PNConnectedCategory:
                            // this is expected for a subscribe, this means there is no error or issue whatsoever
                        case PNReconnectedCategory:
                            // this usually occurs if subscribe temporarily fails but reconnects. This means
                            // there was an error but there is no longer any issue
                        case PNDisconnectedCategory:
                            // this is the expected category for an unsubscribe. This means there
                            // was no error in unsubscribing from everything
                        case PNUnexpectedDisconnectCategory:
                            // this is usually an issue with the internet connection, this is an error, handle appropriately
                        case PNAccessDeniedCategory:
                            // this means that PAM does allow this client to subscribe to this
                            // channel and channel group configuration. This is another explicit error
                        default:
                            // More errors can be directly specified by creating explicit cases for other
                            // error categories of `PNStatusCategory` such as `PNTimeoutCategory` or `PNMalformedFilterExpressionCategory` or `PNDecryptionErrorCategory`
                        }

                    case PNHeartbeatOperation:
                        // heartbeat operations can in fact have errors, so it is important to check first for an error.
                        // For more information on how to configure heartbeat notifications through the status
                        // PNObjectEventListener callback, consult <link to the PNCONFIGURATION heartbeart config>
                        if (status.isError()) {
                            // There was an error with the heartbeat operation, handle here
                        } else {
                            // heartbeat operation was successful
                        }
                    default: {
                        // Encountered unknown status type
                    }
                    }
                } else {
                    // After a reconnection see status.getCategory()
                }
            }

            @Override
            public void message(PubNub pubnub, PNMessageResult message) {
                try {
                    // System.out.println(message);
                    if (message.getChannel().startsWith(KRPubNubChannel.candlestick.getChannel())) {
                        pubnub.json.candlestick.Message hoge = mapper.readValue(message.getMessage().toString(), pubnub.json.candlestick.Message.class);
                        onMessage(pubnub, message, hoge);
                    } else if (message.getChannel().startsWith(KRPubNubChannel.ticker.getChannel())) {
                        pubnub.json.ticker.Message hoge = mapper.readValue(message.getMessage().toString(), pubnub.json.ticker.Message.class);
                        onMessage(pubnub, message, hoge);
                    } else if (message.getChannel().startsWith(KRPubNubChannel.depth.getChannel())) {
                        // PNMessageResult(message={"pid":255060804,"data":{"asks":[["71.134","891.3843"],["71.135","1830.9232"],["71.155","880.6650"],["71.160","13931.6992"],["71.196","40.9722"],["71.199","50.5829"],["71.211","44.0000"],["71.213","180.0271"],["71.220","6643.7404"],["71.223","1.4040"],["71.232","61.7618"],["71.239","154.4045"],["71.241","85.7803"],["71.270","6385.5944"],["71.280","43385.1698"],["71.300","5684.1046"],["71.309","3614.7303"],["71.310","939.0843"],["71.330","8.8388"],["71.351","14025.2454"],["71.366","1.4012"],["71.400","8388.2049"],["71.424","100.0000"],["71.445","100.0000"],["71.449","974.4800"],["71.450","1472.0000"],["71.480","480.6891"],["71.491","1888.0934"],["71.499","2000.0000"],["71.500","12528.6778"],["71.508","1.3984"],["71.514","500.0000"],["71.520","144.5636"],["71.522","195.9371"],["71.530","1390.0000"],["71.540","608.4370"],["71.550","846.8258"],["71.580","976.7372"],["71.598","1000.0000"],["71.599","34.9166"],["71.600","6234.4982"],["71.607","485.8000"],["71.619","350.0000"],["71.625","42369.3711"],["71.633","5506.1978"],["71.634","2381.6094"],["71.640","2121.9024"],["71.650","500.0000"],["71.670","31988.7688"],["71.678","748.0223"],["71.699","34.8679"],["71.700","11914.3976"],["71.740","300.0000"],["71.757","2000.0000"],["71.758","15563.8044"],["71.759","100.0000"],["71.777","3000.0000"],["71.780","976.7572"],["71.789","1000.0000"],["71.790","0.0200"],["71.798","0.1000"],["71.800","15300.3869"],["71.810","0.0200"],["71.813","1.9923"],["71.820","0.0200"],["71.834","6986.3702"],["71.840","8.7144"],["71.841","9980.5289"],["71.843","100.0000"],["71.846","9780.9183"],["71.850","0.0200"],["71.860","0.0400"],["71.870","0.0200"],["71.880","0.0400"],["71.888","1000.0000"],["71.898","600.0000"],["71.900","6371.6857"],["71.920","8434.8223"],["71.935","2273.3787"],["71.945","96.2731"],["71.960","0.0200"],["71.980","39649.3865"],["71.987","104.2823"],["71.988","830.1372"],["71.995","15000.0000"],["71.998","15001.0000"],["71.999","15809.0832"],["72.000","89825.7212"],["72.012","42.6792"],["72.050","0.0200"],["72.070","0.0200"],["72.090","85.7423"],["72.100","28019.6129"],["72.111","2000.0000"],["72.134","5.0588"],["72.139","14000.9800"],["72.142","9.9538"],["72.160","0.0200"],["72.200","19955.1128"],["72.222","3444.7855"],["72.247","5.0420"],["72.250","2040.0000"],["72.300","9818.3986"],["72.301","2000.0000"],["72.330","878.5113"],["72.333","2500.0000"],["72.371","5000.0000"],["72.390","25.0000"],["72.399","743.9508"],["72.400","2086.4363"],["72.428","2500.0000"],["72.440","2000.0000"],["72.444","2500.0000"],["72.458","3.0000"],["72.467","200.0000"],["72.490","4000.0000"],["72.498","0.1000"],["72.499","15418.8353"],["72.500","105630.7438"],["72.510","0.0200"],["72.520","0.0200"],["72.531","1.9923"],["72.540","0.0400"],["72.560","0.0400"],["72.568","100.0000"],["72.575","688.9424"],["72.599","34.4357"],["72.600","62446.8796"],["72.610","0.0200"],["72.630","4200.2600"],["72.664","96.2731"],["72.666","3000.0000"],["72.680","0.0200"],["72.690","150.0200"],["72.699","2356.5528"],["72.700","6737.2084"],["72.701","2306.3699"],["72.732","42.6792"],["72.740","0.0200"],["72.750","22389.8962"],["72.755","9.9544"],["72.775","687.0490"],["72.790","0.0200"],["72.799","7612.0554"],["72.800","35165.0006"],["72.801","2000.0000"],["72.811","586.5440"],["72.820","657.9818"],["72.826","1028.0824"],["72.850","3803.0000"],["72.855","5047.3987"],["72.870","0.0200"],["72.875","500.0000"],["72.879","100.0000"],["72.890","302.5039"],["72.898","1645.0000"],["72.900","18322.3874"],["72.906","2481.2251"],["72.920","2219.0475"],["72.930","0.0200"],["72.940","200.0200"],["72.950","251.7545"],["72.956","1087.7723"],["72.958","300.0000"],["72.970","1405.0627"],["72.984","100.0000"],["72.985","566.7116"],["72.988","11501.6857"],["72.989","500.0000"],["72.990","4569.6789"],["72.995","2000.0000"],["72.997","30000.0000"],["72.998","33071.1154"],["72.999","16271.3329"],["73.000","485511.7786"],["73.005","214.0440"],["73.010","1520.3260"],["73.050","1206.0877"],["73.100","24042.8977"],["73.105","332.4219"],["73.130","2000.0000"],["73.150","100.0000"],["73.152","500.0000"],["73.158","500.0000"],["73.160","0.0200"],["73.200","17657.2792"],["73.210","0.0200"],["73.215","500.0000"],["73.220","0.0200"],["73.250","3071.7261"],["73.251","500.0000"],["73.256","1.9721"],["73.258","200.0000"],["73.292","100.0000"],["73.299","100.0000"],["73.300","22064.9302"],["73.310","4198.1638"],["73.333","500.0000"],["73.340","287.7044"],["73.372","9.9590"]],"bids":[["71.115","797.5455"],["71.090","28972.3990"],["71.060","1038.7419"],["71.050","163.7312"],["71.030","1000.0000"],["71.024","4382.2754"],["71.021","30.0000"],["71.020","30.0000"],["71.013","0.0001"],["71.012","1213.6545"],["71.011","15369.0000"],["71.010","11566.8413"],["71.005","50.0000"],["71.002","447.0667"],["71.001","15438.4853"],["71.000","235144.1365"],["70.995","50.0000"],["70.990","101.0000"],["70.989","211.2795"],["70.980","4000.0000"],["70.975","28187.8101"],["70.970","5712.8723"],["70.950","42.2832"],["70.943","101.0000"],["70.911","174.0000"],["70.905","50.0000"],["70.901","35.2700"],["70.900","20044.5039"],["70.860","5296.4123"],["70.850","334.9612"],["70.830","50.0000"],["70.814","1.4121"],["70.811","180.0000"],["70.801","2904.2862"],["70.800","15463.5952"],["70.771","1.0000"],["70.770","700.0000"],["70.750","234.0000"],["70.711","186.0000"],["70.702","0.0424"],["70.701","4420.0374"],["70.700","52987.5133"],["70.699","900.0000"],["70.670","99.0519"],["70.666","6.6926"],["70.651","1070.7076"],["70.650","4950.5384"],["70.641","150.0000"],["70.640","5.0845"],["70.638","296.8230"],["70.631","10000.0000"],["70.623","145.8661"],["70.621","4493.8022"],["70.620","1050.0000"],["70.616","1643.2927"],["70.613","100.0000"],["70.612","987.2654"],["70.611","192.0000"],["70.610","13102.2957"],["70.601","100.5555"],["70.600","85918.3009"],["70.599","1100.0000"],["70.593","409.0098"],["70.589","3933.0000"],["70.580","1000.0000"],["70.577","13000.0000"],["70.570","3000.0000"],["70.567","2000.0000"],["70.557","3742.1235"],["70.556","36172.9702"],["70.550","5052.5122"],["70.515","900.0000"],["70.511","198.0000"],["70.510","2509.4496"],["70.507","100.0000"],["70.503","10.1412"],["70.502","30.8628"],["70.501","15027.7218"],["70.500","159654.7268"],["70.499","1200.0000"],["70.451","1000.0000"],["70.450","150.0000"],["70.421","5000.0000"],["70.420","5000.0000"],["70.411","205.0000"],["70.402","0.0426"],["70.400","12719.4111"],["70.398","2.1366"],["70.390","7.8351"],["70.350","700.0000"],["70.332","10.0501"],["70.321","2400.5293"],["70.311","211.0000"],["70.310","2896.5913"],["70.301","2026.8378"],["70.300","36171.5806"],["70.298","200.0000"],["70.285","8.8229"],["70.250","15.0000"],["70.243","300.0000"],["70.233","3.0000"],["70.230","0.2728"],["70.211","218.0000"],["70.210","64.3376"],["70.200","64361.5880"],["70.190","30.0000"],["70.170","5437.0174"],["70.156","1000.0000"],["70.150","26016.7950"],["70.133","400.0000"],["70.130","1000.0000"],["70.125","15.0000"],["70.122","4.9458"],["70.120","17.0000"],["70.113","140.0000"],["70.111","1225.0000"],["70.110","48.8631"],["70.102","500.0000"],["70.100","35874.1935"],["70.092","826.3013"],["70.091","2483.8042"],["70.090","1000.0000"],["70.070","1.2000"],["70.050","3.0000"],["70.040","1030.9152"],["70.030","291.6480"],["70.027","2.0000"],["70.012","4.8782"],["70.011","732.0000"],["70.010","4757.8892"],["70.005","5580.1100"],["70.002","0.8570"],["70.001","12862.0381"],["70.000","744247.0457"],["69.999","142.9815"],["69.998","4285.8367"],["69.990","2.0000"],["69.951","6186.2951"],["69.921","12.7931"],["69.911","240.0000"],["69.900","38116.6466"],["69.899","69.9872"],["69.893","43.3793"],["69.890","908.4216"],["69.888","300.0000"],["69.880","108.4372"],["69.860","400.0000"],["69.853","1.4438"],["69.850","1000.0000"],["69.830","104.7091"],["69.811","248.0000"],["69.806","700.0000"],["69.800","30538.1060"],["69.777","1000.0000"],["69.770","289.6215"],["69.760","30.0000"],["69.757","440.0000"],["69.755","10.0000"],["69.750","150.6422"],["69.745","10.0000"],["69.738","9.9591"],["69.737","88.0000"],["69.735","10.0000"],["69.731","2420.8404"],["69.725","10.0000"],["69.711","256.0000"],["69.701","2.1182"],["69.700","11977.7156"],["69.690","189.1637"],["69.680","217.4967"],["69.679","4406.2517"],["69.613","200.0000"],["69.611","264.0000"],["69.600","10011.5269"],["69.588","200.0000"],["69.555","486.1982"],["69.549","1000.0000"],["69.540","1500.0000"],["69.520","8.8218"],["69.511","274.2800"],["69.510","564.0000"],["69.501","71.0000"],["69.500","102076.5630"],["69.488","371.0000"],["69.480","86.3557"],["69.450","50.0000"],["69.428","4.9358"],["69.411","281.0000"],["69.400","9510.2863"],["69.377","430.1476"],["69.358","242.3588"],["69.345","3000.0000"],["69.330","0.0500"],["69.319","4.8669"],["69.311","290.0000"],["69.300","51668.7732"],["69.267","100.0000"],["69.240","30.0000"],["69.229","7166.6648"],["69.222","64.2260"]],"timestamp":1524033954416}}, subscribedChannel=depth_xrp_jpy, actualChannel=null, channel=depth_xrp_jpy, subscription=null, timetoken=15240339552579860, userMetadata=null, publisher=pn-26e99741-8330-4023-a9e2-06df59f10ca8)
                        pubnub.json.depth.Message hoge = mapper.readValue(message.getMessage().toString(), pubnub.json.depth.Message.class);
                        onMessage(pubnub, message, hoge);
                    } else if (message.getChannel().startsWith(KRPubNubChannel.transactions.getChannel())) {
                        pubnub.json.transactions.Message hoge = mapper.readValue(message.getMessage().toString(), pubnub.json.transactions.Message.class);
                        onMessage(pubnub, message, hoge);
                    } else {
                        // ありえない
                        System.err.println(message);
                    }
                } catch (Throwable t) {
                    onError(pubnub, message, t);
                }
            }

            @Override
            public void presence(PubNub pubnub, PNPresenceEventResult presence) {

            }
        });

        pubnub.subscribe().channels(channels()).execute();
    }

    protected final String getFullChannelName(KRPubNubChannel channel, String pair) {
        return String.format("%s_%s", channel.getChannel(), pair);
    }
}
